<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>This is my first EAR attempt</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/initialize.css">
        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
        <script>

        // The all-important beget function from Javascript: the Good Parts
        if (typeof Object.beget !== 'function') {
            Object.beget = function (o) {
                var F = function () {};
                F.prototype = o;
                return new F();
            };
        }

            /*
            *   Global Variables
            *
            */
            var canvas = null;
            var ctx = null;
            var bufferCanvas = null;
            var bufferCanvasCtx = null;
            var mode = "start";
            var startText = "Press any key to start";
            var restartText = "Press any key to restart";
            var score = null;
            var hero = null;
            var weapon = 1;
            var blastArray = [];
            var timer = null;
            var level = null;
            var foo = null;
            var bar = null;
            var animInt = null;
            var countInt = null;
            var enemyInt = null;
            var orbInt = null;
            var imgShiftInt = null;
            var imgShiftVal = 0;
            var enemyArray = [];
                // Score variables
            var score = null;
            var scoreArray = [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000];
            var scoreArrayPos = 0;
            var scoreDisplayArray = [];
            var extraLifeTextPos = 0;

            var lives = null;
            var orb = null;
            var orbArray = [];
            var itemOrbFrequency = 2; // on average, one orb will generate every itemOrbFrequency seconds
            var xBackgroundShift = 0;


            /*
            *   Level Data
            *   timer: max amount of time per level in seconds
            *   genrate: delay between enemy generation in milliseconds
            *   droprate: likelihood of a weapon being dropped in a certain level.
            *       this is calculated as 1/droprate, so a droprate of 1 has an effective droprate of 100%
            *       and a droprate of 1.5 has an effective droprate of 2/3.
            */
            var levelData = [];
                levelData[1] = [];
                levelData[1]['enemies'] = ["crabCakes"];
                levelData[1]['background'] = "img/spacefish/Outer Space Wallpapers/Outer Space-wallpaper-1600x900-013.jpg";
                //levelData[1]['background'] = "img/spacefish/darkBack.png";
                levelData[1]['config'] = { timer : 60, genrate : 2000, droprate : 1 };
                levelData[2] = [];
                levelData[2]['enemies'] = ["bigBloater", "speedyBlue"];
                levelData[2]['background'] = "img/spacefish/Outer-Space-Artwork.jpg";
                levelData[2]['config'] = { timer : 15, genrate : 800, droprate : 1 };
                levelData[3] = [];
                levelData[3]['enemies'] = ["bigBloater", "speedyBlue", "sinusoidSwimmer"];
                levelData[3]['background'] = "img/spacefish/blue-outer-space-stars-planets-nebulae-1680x1050-hd-wallpaper.jpg";
                levelData[3]['config'] = { timer : 18, genrate : 700, droprate : 1 };
                levelData[4] = [];
                levelData[4]['enemies'] = ["speedyBlue", "sinusoidSwimmer", "homingFish"];
                levelData[4]['background'] = "img/spacefish/Outer Space Wallpapers/Outer Space-wallpaper-1600x900-010.jpg";
                levelData[4]['config'] = { timer : 21, genrate : 600, droprate : 1 };
                levelData[5] = [];
                levelData[5]['enemies'] = ["speedyBlue", "sinusoidSwimmer", "homingFish"];
                levelData[5]['background'] = "img/spacefish/Outer Space Wallpapers/Outer Space-wallpaper-1600x900-004.jpg";
                levelData[5]['config'] = { timer : 24, genrate : 500, droprate : 1 };
                levelData[6] = [];
                levelData[6]['enemies'] = ["sinusoidSwimmer", "homingFish", "splitFishBig"];
                levelData[6]['background'] = "img/spacefish/Outer Space Wallpapers/Outer Space-wallpaper-1600x900-008.jpg";
                levelData[6]['config'] = { timer : 27, genrate : 400, droprate : 1 };
                levelData[7] = [];
                levelData[7]['enemies'] = ["sinusoidSwimmer", "homingFish", "splitFishBig"];
                levelData[7]['background'] = "img/spacefish/Outer Space Wallpapers/Outer Space-wallpaper-1600x900-009.jpg";
                levelData[7]['config'] = { timer : 30, genrate : 300, droprate : 1 };
                levelData[8] = [];
                levelData[8]['enemies'] = ["homingFish", "splitFishBig", "spitFireFish"];
                levelData[8]['background'] = "img/spacefish/Outer Space Wallpapers/Outer Space-wallpaper-1600x900-013.jpg";
                levelData[8]['config'] = { timer : 33, genrate : 250, droprate : 1 };
                levelData[9] = [];
                levelData[9]['enemies'] = ["bigBloater", "speedyBlue", "sinusoidSwimmer", "homingFish", "splitFishBig", "spitFireFish"];
                levelData[9]['background'] = "img/spacefish/Outer Space Wallpapers/Outer-Space-Artwork.jpg";
                levelData[9]['config'] = { timer : 36, genrate : 220, droprate : 1 };



            /*
            *   Objects
            *
            */
            function spaceShip() {
                this.w = 120;
                this.h = 60;
                this.x = 0;
                this.y = canvas.height/2 - this.h/2;
                this.color = "white";
                this.weapon = "peaShooter";
                this.defense = "";
                this.defenseTimer = 0;
                this.maxDefenseTimer = 0;
                this.weaponTimer = 0;
                this.maxWeaponTimer = 300;
                this.imgSrcA = "img/spacefish/spaceShipA.png";
                this.imgSrcB = "img/spacefish/spaceShipB.png";
                this.imgSrcShieldA = "img/spacefish/spaceShipShieldA.png";
                this.imgSrcShieldB = "img/spacefish/spaceShipShieldB.png";
                this.imgSrcMegaA = "img/spacefish/spaceShipMegaA.png";
                this.imgSrcMegaB = "img/spacefish/spaceShipMegaB.png";
                this.fire = function() {
                    switch (this.weapon) {
                        case "peaShooter":
                            blastArray[blastArray.length] = new peaShooterBlast();
                            break;
                        case "dualLaser":
                            blastArray[blastArray.length] = new dualLaser(20);
                            blastArray[blastArray.length] = new dualLaser(-20);
                            break;
                        case "bouncyBall":
                            blastArray[blastArray.length] = new bouncyBall(-10);
                            blastArray[blastArray.length] = new bouncyBall(0);
                            blastArray[blastArray.length] = new bouncyBall(10);
                            break;
                        case "shockwave":
                            blastArray[blastArray.length] = new shockwave();
                            break;
                        case "homingMissile":
                            blastArray[blastArray.length] = new homingMissile();
                            break;
                        case "drill":
                            blastArray[blastArray.length] = new drill();
                            break;
                    }
                };
                this.itemUpdate = function(newWeapon) {
                    eval("foo = new " + newWeapon + "()");
                    switch (foo.type) {
                        case "weapon":
                            this.weapon = newWeapon;
                            this.weaponTimer = foo.timer;
                            this.maxWeaponTimer = foo.timer;
                            break;
                        case "defense":
                            this.defense = newWeapon;
                            this.w = 145;
                            this.defenseTimer = foo.timer;
                            this.maxDefenseTimer = foo.timer;
                            break;
                        case "special":
                            this.defense = "mega";
                            this.h = 75;
                            break;
                    }
                   // this.weapon = newWeapon;
                   // this.weaponTimer = this.maxWeaponTimer;
                    switch (newWeapon) {
                        case "dualLaser":
                            hero.color = "red";
                            break;
                        case "peaShooter":
                            hero.color = "yellow";
                            break;
                        case "bouncyBalls":
                            hero.color = "blue";
                            break;
                        case "drill":
                            hero.color = "rgba(0, 255, 255, .25)";
                            break;
                    }
                };
                this.die = function () {
                    lives--;
                    if (lives < 0) {
                        gameOver();
                    }
                    else {
                        playLevel();
                    }
                };
            }

            function itemOrb(item, x, y) {
                this.radius = 15;
                this.x = x;
                this.y = y;
                eval("foo = new " + item + "()"); // foo gets assigned the item object
                this.color = foo.color;
                this.type = foo.type;
                // MARK 2 here is where the orb is collected

                this.weapon = item;
                this.velx = -10;
                this.updatePos = function() {
                    this.x += this.velx;
                };
            }


            /*
            *   Enemies
             */
            function bigBloater() {
                this.w = 300;
                this.h = 150;
                this.x = canvas.width;
                this.y = Math.random() * canvas.height - this.h;
                this.color = "green";
                this.velx = -25;
                this.value = 20;
                this.imgSrcA = "img/spacefish/bigBloaterA.png";
                this.imgSrcB = "img/spacefish/bigBloaterB.png";
                this.itemDrop = "mega";
                this.updatePos = function() {
                    this.x += this.velx;
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function speedyBlue() {
                this.w = 150;
                this.h = 75;
                this.x = canvas.width;
                this.y = Math.random() * canvas.height - this.h;
                this.color = "blue";
                this.velx = -35;
                this.value = 30;
                this.imgSrcA = "img/spacefish/speedyBlueA.png";
                this.imgSrcB = "img/spacefish/speedyBlueB.png";
                this.itemDrop = "dualLaser";
                this.updatePos = function() {
                    this.x += this.velx;
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function sinusoidSwimmer() {
                this.w = 200;
                this.h = 300;
                this.x = canvas.width;
                this.y = (Math.random() * canvas.height/2) + 100;
                this.color = "yellow";
                this.velx = -25;
                this.value = 40;
                this.imgSrcA = "img/spacefish/sinusoidSwimmerA.png";
                this.imgSrcB = "img/spacefish/sinusoidSwimmerB.png";
                this.itemDrop = "shockwave";
                this.updatePos = function() {
                    this.x += this.velx;
                    var sin = Math.sin(this.x * 2.5) * 80;
                    this.y += sin;
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function homingFish() {
                this.w = 230;
                this.h = 115;
                this.x = canvas.width;
                this.y = Math.random() * canvas.height - this.h;
                this.color = "red";
                this.velx = -35;
                this.value = 50;
                this.imgSrcA = "img/spacefish/homingFishA.png";
                this.imgSrcB = "img/spacefish/homingFishB.png";
                this.itemDrop = "homingMissile";
                this.updatePos = function() {
                    this.x += this.velx;
                    var home = ((this.y + this.h/2) > hero.y)? -10 : 10;
                    this.y += home;
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function splitFishBig() {
                this.w = 250;
                this.h = 250;
                this.x = canvas.width;
                this.y = Math.random() * canvas.height - this.h;
                this.color = "purple";
                this.velx = -15;
                this.value = 60;
                this.imgSrcA = "img/spacefish/splitFishBigA.png";
                this.imgSrcB = "img/spacefish/splitFishBigB.png";
                this.itemDrop = "";
                this.updatePos = function() {
                    this.x += this.velx;
                }
                this.getHitBy = function(i, j) {
                    enemyArray[enemyArray.length] = new splitFishMid(this.x, this.y);
                    enemyArray[enemyArray.length] = new splitFishHigh(this.x, this.y);
                    enemyArray[enemyArray.length] = new splitFishLow(this.x, this.y);
                    kill(i, j);
                }
            }

            function splitFishHigh(x, y) {
                this.w = 125;
                this.h = 75;
                this.x = x;
                this.y = y + 50;
                this.color = "purple";
                this.velx = -25;
                this.value = 70;
                this.imgSrcA = "img/spacefish/splitFishSmallA.png";
                this.imgSrcB = "img/spacefish/splitFishSmallB.png";
                this.itemDrop = "bouncyBall";
                this.updatePos = function() {
                    this.x += this.velx;
                    this.y -= 3;
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function splitFishMid(x, y) {
                this.w = 125;
                this.h = 75;
                this.x = x;
                this.y = y + 50;
                this.color = "purple";
                this.velx = -25;
                this.value = 70;
                this.imgSrcA = "img/spacefish/splitFishSmallA.png";
                this.imgSrcB = "img/spacefish/splitFishSmallB.png";
                this.itemDrop = "bouncyBall";
                this.updatePos = function() {
                    this.x += this.velx;
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function splitFishLow(x, y) {
                this.w = 125;
                this.h = 75;
                this.x = x;
                this.y = y + 50;
                this.color = "purple";
                this.velx = -25;
                this.value = 70;
                this.imgSrcA = "img/spacefish/splitFishSmallA.png";
                this.imgSrcB = "img/spacefish/splitFishSmallB.png";
                this.itemDrop = "bouncyBall";
                this.updatePos = function() {
                    this.x += this.velx;
                    this.y += 3;
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function spitFireFish() {
                this.w = 300;
                this.h = 150;
                this.x = canvas.width;
                this.y = Math.random() * canvas.height - this.h;
                this.color = "pink";
                this.velx = -15;
                this.value = 80;
                this.imgSrcA = "img/spacefish/spitFireFishA.png";
                this.imgSrcB = "img/spacefish/spitFireFishB.png";
                this.itemDrop = "drill";
                this.updatePos = function() {
                    this.x += this.velx;
                    if ((this.x < 900 && this.x > 875) || (this.x < 400 && this.x > 375)) {
                        enemyArray[enemyArray.length] = new spitFireBullet(this.x, this.y + this.h/2);
                    }
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }

            function spitFireBullet(x, y) {
                this.w = 10;
                this.h = 10;
                this.x = x + 20;
                this.y = y + 20;
                this.color = "yellow";
                this.velx = -40;
                this.imgSrcA = "img/spacefish/spitFireBulletA.png";
                this.imgSrcB = "img/spacefish/spitFireBulletB.png";
                this.updatePos = function() {
                    this.x += this.velx;
                }
                this.getHitBy = function() {
                    //haha, nothing happens!
                }
            }

            function crabCakes() {
                this.w = 200;
                this.h = 200;
                this.x = canvas.width;
                this.y = Math.random() * canvas.height - this.h;
                this.color = "white";
                this.dirx = "left";
                this.velx = -10 - (Math.random() * 35);
                this.diry = "up";
                this.vely = -10 - (Math.random() * 35);
                this.value = 80;
                this.imgSrcA = "img/spacefish/crabCakesA.png";
                this.imgSrcB = "img/spacefish/crabCakesB.png";
                this.itemDrop = "drill";
                this.updatePos = function() {
                    this.x += this.velx;
                    if (this.x < 0 && this.dirx == "left") {
                        this.dirx = "right";
                        this.velx = 10 + (Math.random() * 35);
                    }
                    if (this.x > canvas.width - this.w && this.dirx == "right") {
                        this.dirx = "left";
                        this.velx = - (10 + (Math.random() * 35));
                    }
                    this.y += this.vely;
                    if (this.y < 0 && this.diry == "up") {
                        this.diry = "down";
                        this.vely = 10 + (Math.random() * 35);
                    }
                    if (this.y > canvas.height - this.h && this.diry == "down") {
                        this.diry = "up";
                        this.vely = - (10 + (Math.random() * 35));
                    }
                }
                this.getHitBy = function(i, j) {
                    kill(i, j);
                }
            }


            /*
            *   Weapons
            */
            function peaShooterBlast() {
                this.w = 30;
                this.h = 10;
                this.radius = 10;
                this.y = hero.y + hero.h/2 - this.h/2;
                this.x = hero.w;
                this.color = "yellow";
                this.velx = 25;
                this.updatePos = function() {
                    this.x += this.velx;
                };
            }

            function dualLaser(loc) {
                this.type = "weapon";
                this.timer = 150;
                this.w = 80;
                this.h = 10;
                this.radius = 15;
                this.y = hero.y + hero.h/2 - this.h/2 + loc;
                this.x = hero.w;
                this.color = "red";
                this.velx = 25;
                this.updatePos = function() {
                    this.x += this.velx;
                };
            }

            function shockwave() {
                this.type = "weapon";
                this.timer = 150;
                this.w = 20;
                this.h = 70;
                this.radius = 10;
                this.y = hero.y;
                this.x = hero.w;
                this.color = "yellow";
                this.velx = 15;
                this.dir = "down";
                this.vely = 25;
                this.velyCount = 0;
                this.updatePos = function() {
                    this.x += this.velx;
                    if (this.dir == "down") {
                        this.y += this.vely;
                        this.velyCount++;
                        if (this.velyCount >= 4) {this.velyCount = 0; this.dir = "up";}
                    } else if (this.dir == "up") {
                        this.y -= this.vely;
                        this.velyCount++;
                        if (this.velyCount >= 4) {this.velyCount = 0; this.dir = "down";}
                    }
                };
            }

            function homingMissile() {
                this.type = "weapon";
                this.timer = 150;
                this.w = 60;
                this.h = 30;
                this.radius = 30;
                this.y = hero.y;
                this.x = hero.w;
                this.color = "rgba(255,0,0,.25)";
                this.velx = 20;
                this.updatePos = function() {
                    if (enemyArray.length > 0) {
                        var enemyYPos = enemyArray[enemyArray.length-1].y;
                        this.y += (enemyYPos - this.y) * .05;
                    }
                    this.x += this.velx;
                };
            }

            function bouncyBall(dir) {
                this.type = "weapon";
                this.timer = 150;
                this.w = 20;
                this.h = 20;
                this.radius = 20;
                this.y = hero.y + hero.h/2 - this.h/2;
                this.x = hero.w;
                this.color = "blue";
                this.velx = 20;
                this.vely = dir;
                this.updatePos = function() {
                    if (this.y > canvas.height || this.y < 0) { this.vely = -this.vely; }
                    this.x += this.velx;
                    this.y += this.vely;
                };
            }

            function drill() {
                this.type = "defense";
                this.w = hero.w * 2;
                this.h = hero.h;
                this.y = hero.y;
                this.x = hero.x;
                this.color = "rgba(0, 255, 255, .25)";
                this.timer = 500;
                this.updatePos = function() {
                    // it don't go nowhere!!!
                };
            }

            function mega() {
                this.type = "special";
                this.w = hero.w;
                this.h = hero.h;
                this.y = hero.y;
                this.x = hero.x;
                this.color = "rgba(255, 255, 255, .20)";
                //this.timer = 100;
                this.updatePos = function() {
                    // it don't go nowhere!!!
                };
            }


            /*
            *   Events & Actions
            *
            */
            document.onkeydown = keyPress;
            document.onmousemove = moveMouse;
            document.onmouseup = mousePress;

            function keyPress(e) {
                if (mode == "start") {
                    clearInterval(openingTimer);
                    mode = "game";
                    level = 1;
                    playLevel();
                }
                if (mode == "gameOver") {
                    clearInterval(endingTimer);
                    mode = "start";
                    lives = 2;
                    score = 0;
                    initialize();
                }
            }

            function moveMouse(e) {
                if (hero) {
                    if (e.pageY < canvas.height) {
                        hero.y = e.pageY;
                    } else {
                        hero.y = canvas.height - hero.h;
                    }
                }
            }

            function mousePress() {
                if (hero) {
                    fireWeapon(weapon);
                }
            }



            /*
            *     Game Actions
            *
            */
            function fireWeapon(weapon) {
              hero.fire();
            }

            function countdown() {
                timer -= 1;
                if(timer <= 0) {
                    level++;
                    playLevel();
                }
            }

            function addEnemy() {
                var num = Math.floor(Math.random() * levelData[level]['enemies'].length);
                eval("enemyArray[enemyArray.length] = new " + levelData[level]['enemies'][num]);
            }

            function shiftImgSrc() {
                imgShiftVal = (imgShiftVal == 0)? 1 : 0;
            }

            function kill(i, j) {
                // remove the blast from blastArray
                if (j != 100) {
                    for (i; i < blastArray.length - 1; i++) {
                        blastArray[i] = blastArray[i+1];
                    }
                    blastArray.pop();
                }

                // release the orb
                if (enemyArray[j].itemDrop) {
                    var go = Math.random() * levelData[level]['config'].droprate;
                    if (go < 1) {
                        orbArray[orbArray.length] = new itemOrb(enemyArray[j].itemDrop, enemyArray[j].x + (enemyArray[j].w/2), enemyArray[j].y + (enemyArray[j].h/2));
                    } // MARK 1 here is where the item is dropped initially
                }

                // now do the score and extra life thang
                score += enemyArray[j].value;
                if (score >= scoreArray[scoreArrayPos]) {
                    lives++;
                    extraLifeTextPos = 1;
                    scoreArrayPos++;
                }
                scoreDisplayArray[scoreDisplayArray.length] = {
                    x : enemyArray[j].x + (enemyArray[j].w/2),
                    y : enemyArray[j].y + (enemyArray[j].h/2),
                    value : enemyArray[j].value,
                    pos : 0,
                    alpha : 1
                };



                for (j; j < enemyArray.length - 1; j++) {
                    enemyArray[j] = enemyArray[j+1];
                }
                enemyArray.pop();
            }

            function gameOver() {
                if (animInt) { window.clearInterval(animInt); }
                if (countInt) { window.clearInterval(countInt); }
                if (enemyInt) { window.clearInterval(enemyInt); }
                blastArray = [];
                enemyArray = [];

                mode = "gameOver";

                initialize();
            }


            /*
            *       Game State Functions
            *
            */
            function initialize() {
                canvas = document.getElementById("canvas");
                ctx  = canvas.getContext("2d");

                bufferCanvas = document.createElement("canvas");
                bufferCanvasCtx = bufferCanvas.getContext("2d");
                bufferCanvasCtx.canvas.width = ctx.canvas.width;
                bufferCanvasCtx.canvas.height = ctx.canvas.height;

                //initialize game variables
                score = 0;
                level = 0;
                lives = 2;
               // maxTime = 10;


                if (mode == "start") {
                    score = 0;
                    openingTimer = setInterval(drawOpening, 300);
                }


                if (mode == "gameOver") {
                    endingTimer = setInterval(drawEnding, 300);
                }
            }

            function playLevel() {
                hero = new spaceShip();
                timer = levelData[level]['config'].timer;

                // clear compound variables
                if (animInt) { window.clearInterval(animInt); }
                if (countInt) { window.clearInterval(countInt); }
                if (enemyInt) { window.clearInterval(enemyInt); }
                //if (orbInt) { window.clearInterval(orbInt); }
                if (imgShiftInt) { window.clearInterval(imgShiftInt); }
                blastArray = [];
                enemyArray = [];
                orbArray = [];
                scoreDisplayArray = [];
                xBackgroundShift = 0;

                // level splash screen
                mode = "levelSplash";
                levelSplash();

                // play the level
                mode = "game";

                setTimeout(function() {
                    animInt = setInterval(animate, 30);
                    countInt = setInterval(countdown, 1000);
                    enemyInt = setInterval(addEnemy, levelData[level]['config'].genrate);
                    //orbInt = setInterval(addOrb, 1000);
                    imgShiftInt = setInterval(shiftImgSrc, 500);
                }, 1000);
            }

            function drawOpening() {
                ctx.save();

                blank();

                bufferCanvasCtx.fillStyle = "white";
                bufferCanvasCtx.font = "50pt Arial";
                bufferCanvasCtx.fillText("SPACEFISH", canvas.width/2 - 200, canvas.height/2 -130);

                bufferCanvasCtx.font = "30pt Arial";
                bufferCanvasCtx.fillText("by M.A.R.K.", canvas.width/2 - 120, canvas.height/2 -60);

                bufferCanvasCtx.fillStyle = "white";
                bufferCanvasCtx.font = "25pt Arial";
                bufferCanvasCtx.fillText(startText, canvas.width/2 - 180, canvas.height/2 + 30);

                if (startText == "Press any key to start")  {startText = "";}
                else { startText = "Press any key to start"; }

                // copy the entire rendered image from the bugger canvas to the visible one
                ctx.drawImage(bufferCanvas, 0, 0, bufferCanvas.width, bufferCanvas.height);
                ctx.restore();
            }

            function drawEnding() {
                ctx.save();

                blank();

                bufferCanvasCtx.font = "50pt Arial";
                bufferCanvasCtx.fillStyle = "white";
                bufferCanvasCtx.fillText("GAME OVER", canvas.width/2 - 170, canvas.height/2);

                bufferCanvasCtx.fillStyle = "white";
                bufferCanvasCtx.font = "25pt Arial";
                bufferCanvasCtx.fillText(restartText, canvas.width/2 - 150, canvas.height/2 + 90);

                if (restartText == "Press any key to restart")  {restartText = "";}
                else { restartText = "Press any key to restart"; }

                // copy the entire rendered image from the bugger canvas to the visible one
                ctx.drawImage(bufferCanvas, 0, 0, bufferCanvas.width, bufferCanvas.height);
                ctx.restore();
            }

            function levelSplash() {
                ctx.save();
                blank();
                bufferCanvasCtx.fillStyle = "white";
                bufferCanvasCtx.font = "40pt Arial";

                var levelText = "Level " + level;

                bufferCanvasCtx.fillText(levelText, bufferCanvas.width/2 - 100, bufferCanvas.height/2 - 20);
                ctx.drawImage(bufferCanvas, 0, 0, bufferCanvas.width, bufferCanvas.height);
                ctx.restore();
            }



            /*
             *  Updating and Rendering
             *
            */
            function blank() {
                if (level > 0) {
                    var backgroundImg = new Image();
                    backgroundImg.src = levelData[level]['background'];
                    bufferCanvasCtx.drawImage(backgroundImg, xBackgroundShift, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
                } else {
                    bufferCanvasCtx.fillStyle = "#000";
                    bufferCanvasCtx.fillRect(0,0,bufferCanvasCtx.canvas.width, bufferCanvasCtx.canvas.height);
                }
            }

            function animate() {
                Update();
                Draw();
            }

            function Update() {
                for (var i = 0; i < blastArray.length; i++) {
                    blastArray[i].updatePos();
                    if(blastArray[i].x > canvas.width) {
                        blastArray.shift();
                    }
                }
                for (var i = 0; i < enemyArray.length; i++) {
                    enemyArray[i].updatePos();
                }

                for (var i = 0; i < blastArray.length; i++) {
                    for (var j = 0; j < enemyArray.length; j++) {
                        if (
                                (blastArray[i].x + blastArray[i].w > enemyArray[j].x) &&
                                        (blastArray[i].x < enemyArray[j].x + enemyArray[j].w) &&
                                        (blastArray[i].y + blastArray[i].h > enemyArray[j].y) &&
                                        (blastArray[i].y < enemyArray[j].y + enemyArray[j].h)
                                ) { enemyArray[j].getHitBy(i, j); }
                    }
                }
                // cycle through the enemyArray and see if the hero gets hit
                for (var i = 0; i < enemyArray.length; i++) {
                    if (
                            (hero.x + (hero.w/2) > enemyArray[i].x) &&
                            (hero.x < enemyArray[i].x + enemyArray[i].w) &&
                            (hero.y + hero.h > enemyArray[i].y) &&
                            (hero.y < enemyArray[i].y + enemyArray[i].h)
                       ) {
                        switch (hero.defense) {
                            case "drill":
                                enemyArray[i].getHitBy(0, i);
                                break;
                            case "mega":
                                enemyArray[i].getHitBy(0, i);
                                hero.defense = "";
                                break;
                            default :
                                hero.die();
                                break;
                            }
                        }
                }

                for (var i = 0; i < orbArray.length; i++) {
                    orbArray[i].updatePos();
                    if (
                            (hero.x + hero.w > orbArray[i].x) &&
                            (hero.x < orbArray[i].x + orbArray[i].radius) &&
                            (hero.y + hero.h > orbArray[i].y) &&
                            (hero.y < orbArray[i].y + orbArray[i].radius)
                       ) {
                        hero.itemUpdate(orbArray[i].weapon);
                        //alert(hero.weapon);
                        orbArray.shift();
                        // MARK 3 this calls the hero's itemUpdate() function
                    }
                }

                if (hero.defenseTimer > 0) {
                    hero.defenseTimer--;
                    if (hero.defenseTimer <= 0) {
                        hero.defense = "";
                        hero.w = 120;
                        hero.color = "yellow";
                    }
                }
                if (hero.weaponTimer > 0) {
                    hero.weaponTimer--;
                    if (hero.weaponTimer <= 0) {
                        hero.weapon = "peaShooter";
                        hero.color = "yellow";
                    }
                }


               for (var i = 0; i < scoreDisplayArray.length; i++) {
                    scoreDisplayArray[i].alpha -= .04;
                    scoreDisplayArray[i].pos += 10;
                    if (scoreDisplayArray[i].pos > 200) { scoreDisplayArray.shift(); }
                }

                if (extraLifeTextPos > 0) {
                    extraLifeTextPos += 5;
                    if (extraLifeTextPos > 100) {
                        extraLifeTextPos = 0;
                    }
                }

                xBackgroundShift += .25;
            }

            function Draw() {
                ctx.save();

                blank();

                // Hero
                var heroImg = new Image();
                if (hero.defense == "drill") {
                    heroImg.src = (imgShiftVal == 0)? hero.imgSrcShieldA : hero.imgSrcShieldB;
                } else if (hero.defense == "mega") {
                    heroImg.src = (imgShiftVal == 0)? hero.imgSrcMegaA : hero.imgSrcMegaB;
                } else {
                    heroImg.src = (imgShiftVal == 0)? hero.imgSrcA : hero.imgSrcB;
                }
                bufferCanvasCtx.drawImage(heroImg, hero.x, hero.y);

                // Hero's blasts
                bufferCanvasCtx.save();
                for (var i = 0; i < blastArray.length; i++) {
                    bufferCanvasCtx.fillStyle = blastArray[i].color;
                    //bufferCanvasCtx.fillRect(blastArray[i].x, blastArray[i].y, blastArray[i].w, blastArray[i].h);
                    bufferCanvasCtx.beginPath();
                    bufferCanvasCtx.arc(blastArray[i].x, blastArray[i].y, blastArray[i].radius, 0, 2 * Math.PI);
                    // render the shadow
                    bufferCanvasCtx.shadowOffsetX = 0;
                    bufferCanvasCtx.shadowOffsetY = 0;
                    bufferCanvasCtx.shadowColor = blastArray[i].color;
                    bufferCanvasCtx.shadowBlur = 100;

                    bufferCanvasCtx.fill();
                }
                bufferCanvasCtx.restore();

                // Enemies
                for (var i = 0; i < enemyArray.length; i++) {
                    var img = new Image();
                    img.src = (imgShiftVal == 0)? enemyArray[i].imgSrcA : enemyArray[i].imgSrcB;
                    bufferCanvasCtx.drawImage(img, enemyArray[i].x, enemyArray[i].y);
                 }

                for (var i = 0; i < orbArray.length; i++) {
                    bufferCanvasCtx.fillStyle = orbArray[i].color;
                    bufferCanvasCtx.beginPath();
                    bufferCanvasCtx.arc(orbArray[i].x, orbArray[i].y, orbArray[i].radius, 0, 2 * Math.PI);
                    bufferCanvasCtx.fill();
                }

                // Timer
                bufferCanvasCtx.fillStyle = "#DDD";
                bufferCanvasCtx.font = "30pt Arial";
                bufferCanvasCtx.fillText(timer, canvas.width/2 - 20, 50);
                // Level
                bufferCanvasCtx.fillStyle = "#DDD";
                bufferCanvasCtx.font = "20pt Arial";
                var levelText = "Level " + level;
                bufferCanvasCtx.fillText(levelText, 10, 45);
                // Score Count
                bufferCanvasCtx.fillStyle = "#DDD";
                bufferCanvasCtx.font = "20pt Arial";
                var scoreText = "Score: " + score;
                bufferCanvasCtx.fillText(scoreText, 250, 45);

                // Shield Timer
                var barHeight = (hero.weaponTimer > 0)? 60 : 30;
                if (hero.defense == "drill") {
                    bufferCanvasCtx.fillStyle = "rgba(0,255,255,.5)";
                    bufferCanvasCtx.fillRect(((hero.maxDefenseTimer - hero.defenseTimer)* (canvas.width/hero.maxDefenseTimer))/2, canvas.height-barHeight, (hero.defenseTimer * (canvas.width/hero.maxDefenseTimer)), 30);
                    bufferCanvasCtx.fillStyle = "white";
                    bufferCanvasCtx.font = "20pt Arial";
                    bufferCanvasCtx.fillText(hero.defense, canvas.width/2 - 30, canvas.height - (barHeight - 25));
                } else if (hero.defense == "mega") {
                    bufferCanvasCtx.fillStyle = "rgba(255,255,255,.3)";
                    bufferCanvasCtx.fillRect(0, canvas.height - barHeight, canvas.width, 30);
                    bufferCanvasCtx.fillStyle = "white";
                    bufferCanvasCtx.font = "20pt Arial";
                    bufferCanvasCtx.fillText("Mega Mode", canvas.width/2 - 30, canvas.height - (barHeight - 25));

                }
                // Weapon Timer

                if (hero.weaponTimer > 0) {
                   eval("foo = new " + hero.weapon + ";");
                   bufferCanvasCtx.fillStyle = foo.color;
                    //bufferCanvasCtx.fillStyle = "red";
                   bufferCanvasCtx.fillRect(((hero.maxWeaponTimer - hero.weaponTimer)* (canvas.width/hero.maxWeaponTimer))/2, canvas.height-30, (hero.weaponTimer * (canvas.width/hero.maxWeaponTimer)), 30);
                   bufferCanvasCtx.fillStyle = "white";
                   bufferCanvasCtx.font = "20pt Arial";
                   bufferCanvasCtx.fillText(hero.weapon, canvas.width/2 - 30, canvas.height - 5);
                }

                // Dynamic Score Display
                bufferCanvasCtx.font = "20pt Arial";
                for (var i = 0; i < scoreDisplayArray.length; i++) {
                    bufferCanvasCtx.fillStyle = "rgba(255, 255, 255, " + scoreDisplayArray[i].alpha + ")";
                    bufferCanvasCtx.fillText(scoreDisplayArray[i].value, scoreDisplayArray[i].x, scoreDisplayArray[i].y - scoreDisplayArray[i].pos);
                }

                // Extra Life
                if (extraLifeTextPos > 0) {
                    bufferCanvasCtx.fillStyle = "#DDD";
                    bufferCanvasCtx.font = "30pt Arial";
                    bufferCanvasCtx.fillText("EXTRA LIFE!", 900, 160-extraLifeTextPos);
                }
                // Lives
                bufferCanvasCtx.fillStyle = (extraLifeTextPos > 0)? "#FFF" : "#DDD";
                bufferCanvasCtx.drawImage(heroImg, 900, 15);
                bufferCanvasCtx.font = (extraLifeTextPos > 0)? "35pt Arial" : "30pt Arial";
                var livesText = " x " + lives;
                bufferCanvasCtx.fillText(livesText, 1025, 57);

                // copy the entire rendered image from the bugger canvas to the visible one
                ctx.drawImage(bufferCanvas, 0, 0, bufferCanvas.width, bufferCanvas.height);
                ctx.restore();
            }



        </script>
        <style>
            canvas#canvas {
                background-color: #000;
            }
        </style>
    </head>
    <body onload="initialize();">

        <!-- Add your site or application content here -->
        <canvas id="canvas" height="700" width="1200">Joo cannot see me!</canvas>

        <br/><br/>

        <audio controls="controls">
            <source src="assets/spacefish/SalmonDance.m4a" type="audio/mpeg">
        </audio>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="js/plugins.js"></script>
        <script src="js/initialize.js"></script>



        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>
